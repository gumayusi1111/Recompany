# 后端项目架构说明文档

## 项目概述

本项目采用 Express.js + TypeScript 构建，使用模块化架构设计，为前端提供 RESTful API 服务。目前使用内存中的模拟数据，未来计划集成 Prisma ORM 连接真实数据库。

## 目录结构

```
src/
├── modules/               # 业务模块目录
│   ├── about/            # About 模块
│   │   ├── controllers/  # 控制器 - 处理请求和响应
│   │   ├── services/     # 服务 - 业务逻辑
│   │   ├── schemas/      # 模式 - 请求验证
│   │   ├── routes/       # 路由 - API 端点定义
│   │   ├── types/        # 类型 - 类型定义
│   │   └── index.ts      # 模块入口
│   ├── contact/          # Contact 模块（结构同上）
│   ├── home/             # Home 模块（结构同上）
│   ├── products/         # Products 模块（结构同上）
│   ├── projects/         # Projects 模块（结构同上）
│   ├── materials/        # Materials 模块（结构同上）
│   ├── testimonials/     # Testimonials 模块（结构同上）
│   └── news/             # News 模块（结构同上）
├── middleware/           # 中间件
│   └── validateRequest.ts # 请求验证中间件
├── routes/               # 路由目录
│   └── auth.ts           # 认证路由
├── app.ts                # 应用配置
├── routes.ts             # 主路由配置
├── server.ts             # 服务器入口
└── swagger.ts            # Swagger 文档配置
```

## 模块结构说明

每个业务模块都遵循相同的标准化结构，分为以下几个部分：

### 1. 控制器 (controllers/)

控制器负责处理 HTTP 请求，调用相应的服务，并返回响应。

**文件结构**：
- `{module}.controller.ts` - 包含模块的所有控制器函数
- `index.ts` - 导出所有控制器

**功能**：
- 接收请求参数
- 调用服务层处理业务逻辑
- 返回统一格式的响应 `{ code, msg, data }`
- 处理异常情况

**修改方法**：
- 添加新的控制器函数
- 修改现有控制器的参数处理或响应格式
- 调整错误处理逻辑

### 2. 服务 (services/)

服务层封装业务逻辑，与数据层交互。目前使用内存中的模拟数据，未来将替换为 Prisma 数据库操作。

**文件结构**：
- `{module}.service.ts` - 包含模块的所有服务函数
- `index.ts` - 导出所有服务

**功能**：
- 实现业务逻辑
- 处理数据操作（当前是模拟数据，未来是数据库操作）
- 返回处理结果给控制器

**修改方法**：
- 添加新的服务函数
- 修改现有服务的业务逻辑
- 集成 Prisma 替换模拟数据

### 3. 模式 (schemas/)

使用 Zod 库定义请求验证模式和类型。

**文件结构**：
- `{module}.schema.ts` - 包含模块的所有验证模式
- `index.ts` - 导出所有模式和类型

**功能**：
- 定义请求数据的验证规则
- 生成 TypeScript 类型定义
- 与验证中间件配合使用

**修改方法**：
- 添加新的验证模式
- 修改现有模式的字段或验证规则
- 更新类型定义

### 4. 路由 (routes/)

定义模块的 API 路径和处理方法，使用 Swagger 注释添加 API 文档。

**文件结构**：
- `{module}.routes.ts` - 包含模块的所有路由定义
- `index.ts` - 导出路由

**功能**：
- 定义 RESTful API 端点
- 关联路由与控制器
- 添加请求验证中间件
- 包含 Swagger 文档注释

**修改方法**：
- 添加新的路由
- 修改现有路由的路径或处理方法
- 更新 Swagger 注释

### 5. 类型 (types/)

从模式中导出类型定义，用于类型检查。

**文件结构**：
- `index.ts` - 从模式中导出类型

**功能**：
- 集中管理和导出类型定义
- 简化类型导入

**修改方法**：
- 更新类型导出

### 6. 模块入口 (index.ts)

导入路由并选择性导出类型，作为模块的统一入口。

**功能**：
- 导出路由作为默认导出
- 选择性导出类型
- 提供模块的统一访问点

**修改方法**：
- 调整导出内容

## 核心文件说明

### app.ts

应用配置文件，设置中间件、跨域处理和路由。

**功能**：
- 创建 Express 应用
- 配置中间件（CORS、JSON 解析等）
- 注册主路由和认证路由
- 设置 Swagger 文档

**修改方法**：
- 添加新的全局中间件
- 修改 CORS 配置
- 添加新的顶级路由

### routes.ts

主路由配置文件，动态注册各模块的路由。

**功能**：
- 定义模块配置（路径、模块路径、是否模块化）
- 动态导入和注册路由
- 提供统一的路由入口

**修改方法**：
- 添加新的模块配置
- 修改现有模块的路径或配置
- 调整路由注册逻辑

### server.ts

服务器入口文件，启动 Express 应用。

**功能**：
- 设置服务器端口
- 启动 Express 应用
- 输出服务器运行信息

**修改方法**：
- 修改端口配置
- 添加服务器启动前的初始化代码

### middleware/validateRequest.ts

请求验证中间件，使用 Zod 模式验证请求数据。

**功能**：
- 验证请求数据（体、参数、查询）
- 返回统一的验证错误响应
- 在验证通过时调用下一个中间件

**修改方法**：
- 调整验证逻辑
- 修改错误响应格式

### swagger.ts

Swagger 文档配置文件，设置 API 文档。

**功能**：
- 配置 Swagger UI
- 设置 API 文档信息
- 自动生成 API 文档

**修改方法**：
- 修改文档信息
- 调整 Swagger 配置

## Prisma 集成指南（未来计划）

目前项目使用内存中的模拟数据，未来计划集成 Prisma ORM 连接真实数据库。以下是集成步骤：

1. **安装 Prisma**：
   ```bash
   npm install prisma --save-dev
   npm install @prisma/client
   npx prisma init
   ```

2. **定义数据模型**：
   在 `prisma/schema.prisma` 文件中定义数据模型。

3. **执行数据库迁移**：
   ```bash
   npx prisma migrate dev --name init
   ```

4. **生成 Prisma 客户端**：
   ```bash
   npx prisma generate
   ```

5. **创建 Prisma 服务**：
   创建 `src/lib/prisma.ts` 文件，导出 Prisma 客户端实例。

6. **修改服务层**：
   在各模块的服务层中，用 Prisma 客户端替换模拟数据。

## API 响应格式

所有 API 遵循统一的响应格式：

```json
{
  "code": 0,       // 状态码：0 表示成功，非 0 表示失败
  "msg": "消息",  // 状态消息
  "data": {}      // 响应数据
}
```

## 错误处理

所有模块都使用统一的错误处理方式：

- HTTP 状态码反映请求处理状态
- 响应体中的 `code` 字段反映业务处理状态
- 响应体中的 `msg` 字段提供错误描述
- 控制器中使用 try-catch 捕获异常

## 注意事项

1. **不要硬编码**：
   - 使用环境变量存储配置
   - 避免在代码中直接写入敏感信息
   - 使用常量管理固定值

2. **保持一致性**：
   - 遵循统一的命名约定
   - 保持响应格式一致
   - 使用相同的模块结构

3. **文档维护**：
   - 更新 Swagger 注释
   - 保持代码注释最新
   - 记录 API 变更

4. **渐进式迁移**：
   - 当引入 Prisma 时，逐个模块迁移
   - 保持向后兼容
   - 添加测试确保功能正常
